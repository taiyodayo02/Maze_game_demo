<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éî„ÇØ„Çª„É´ „ÇÅ„ÅÑ„Çç„Ç≤„Éº„É†</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 10px;
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        
        .game-container {
            width: 100%;
            max-width: 500px;
            background: #0f0f23;
            border: 3px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .title {
            font-size: 18px;
            color: #00ff00;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #006600;
        }
        
        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #cc4125;
            touch-action: manipulation;
        }
        
        .button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc4125;
        }
        
        .button:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .stage-button {
            background: linear-gradient(45deg, #4834d4, #686de0);
            box-shadow: 0 4px 0 #3742fa;
            margin: 5px;
            padding: 10px 15px;
            font-size: 9px;
        }
        
        .stage-button:hover {
            box-shadow: 0 2px 0 #3742fa;
        }
        
        .stage-button:disabled {
            background: #666;
            box-shadow: 0 4px 0 #333;
            opacity: 0.5;
        }
        
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .character-select-container {
            margin: 20px 0;
        }
        
        .character-select {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .character-select::-webkit-scrollbar {
            display: none;
        }
        
        .character-button {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            box-shadow: 0 4px 0 #2f3542;
            font-size: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            min-height: 120px;
            flex-shrink: 0;
            scroll-snap-align: center;
            border-radius: 8px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .character-button.selected {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            box-shadow: 0 4px 0 #ff4757;
            transform: scale(1.05);
        }
        
        .character-button:disabled {
            opacity: 0.5;
            transform: none;
        }

        .character-image {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border: 2px solid #2f3542;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            image-rendering: pixelated;
        }

        .character-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .character-name {
            font-size: 8px;
            text-align: center;
            line-height: 1.2;
            color: #ffffff;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .difficulty-select {
            margin: 15px 0;
        }
        
        .difficulty-button {
            background: linear-gradient(45deg, #5f27cd, #a55eea);
            font-size: 9px;
            padding: 8px 15px;
            margin: 4px;
        }
        
        .difficulty-button.selected {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
        }
        
        .game-canvas {
            border: 2px solid #00ff00;
            background: #1a1a2e;
            margin: 15px 0;
            image-rendering: pixelated;
            max-width: 100%;
            height: auto;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 8px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .inventory {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .inventory-item {
            width: 35px;
            height: 35px;
            background: #2f3542;
            border: 2px solid #57606f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border-radius: 4px;
        }
        
        .inventory-item.has-item {
            background: #ffa502;
            border-color: #ff9ff3;
        }
        
        .controls {
            margin: 10px 0;
            font-size: 7px;
            color: #a4b0be;
            line-height: 1.3;
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #0984e3, #74b9ff);
            border: 4px solid #ffffff;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            max-width: 280px;
            display: none;
        }
        
        .popup.show {
            display: block;
            animation: popupBounce 0.5s ease-out;
        }
        
        @keyframes popupBounce {
            0% { transform: translate(-50%, -50%) scale(0.3); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .popup-title {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0px #0984e3;
        }
        
        .popup-message {
            font-size: 10px;
            color: #ffffff;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .popup-button {
            background: linear-gradient(45deg, #00b894, #55efc4);
            color: white;
            border: none;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 9px;
            cursor: pointer;
            border-radius: 6px;
            box-shadow: 0 4px 0 #00a085;
            touch-action: manipulation;
        }
        
        .popup-button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #00a085;
        }
        
        .scroll-hint {
            font-size: 7px;
            color: #a4b0be;
            margin-top: 5px;
        }
        
        /* „Çπ„Éû„ÉõÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
        @media (max-width: 600px) {
            body {
                padding: 5px;
                min-height: 100vh;
                overflow-x: hidden;
            }
            
            .game-container {
                max-width: 100%;
                padding: 10px;
                border-width: 2px;
            }
            
            .title {
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .game-canvas {
                width: 100%;
                max-width: 350px;
                height: auto;
            }
            
            .character-button {
                min-width: 80px;
                min-height: 100px;
            }
            
            .character-image {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- „Çø„Ç§„Éà„É´ÁîªÈù¢ -->
        <div id="title-screen" class="screen active">
            <div class="title">üè∞ „Éî„ÇØ„Çª„É´ „ÇÅ„ÅÑ„Çç„Ç≤„Éº„É† üè∞</div>
            <div style="margin: 20px 0; font-size: 10px; line-height: 1.4;">
                „ÇÅ„ÅÑ„Çç„Çí„ÇØ„É™„Ç¢„Åó„Å¶<br>
                „Å§„Çà„ÅÑÊïµ„ÇíÂÄí„Åù„ÅÜÔºÅ
            </div>
            <button class="button" onclick="showStageSelect()">„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
        </div>
        
        <!-- „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="stage-select" class="screen">
            <div class="title">„Çπ„ÉÜ„Éº„Ç∏„Åõ„Çì„Åü„Åè</div>
            <div class="stage-grid">
                <button class="stage-button button" onclick="showCharacterSelect(1)">„Çπ„ÉÜ„Éº„Ç∏ 1</button>
                <button class="stage-button button" onclick="showCharacterSelect(2)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 2</button>
                <button class="stage-button button" onclick="showCharacterSelect(3)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 3</button>
                <button class="stage-button button" onclick="showCharacterSelect(4)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 4</button>
                <button class="stage-button button" onclick="showCharacterSelect(5)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 5</button>
                <button class="stage-button button" onclick="showCharacterSelect(6)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 6</button>
                <button class="stage-button button" onclick="showCharacterSelect(7)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 7</button>
                <button class="stage-button button" onclick="showCharacterSelect(8)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 8</button>
                <button class="stage-button button" onclick="showCharacterSelect(9)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 9</button>
                <button class="stage-button button" onclick="showCharacterSelect(10)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 10</button>
                <button class="stage-button button" onclick="showCharacterSelect(11)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 11</button>
                <button class="stage-button button" onclick="showCharacterSelect(12)" disabled>„Çπ„ÉÜ„Éº„Ç∏ 12</button>
            </div>
            <button class="button" onclick="showTitle()">„ÇÇ„Å©„Çã</button>
        </div>
        
        <!-- „Ç≠„É£„É©„ÇØ„Çø„Éº„ÉªÈõ£ÊòìÂ∫¶ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="character-select" class="screen">
            <div class="title">„Ç≠„É£„É©„ÇØ„Çø„Éº & „Å™„Çì„ÅÑ„Å©</div>
            <div style="font-size: 9px; margin-bottom: 10px;">„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Åà„Çâ„Åº„ÅÜÔºÅ</div>
            <div class="character-select-container">
                <div class="character-select">
                    <button class="character-button button selected" data-character="„Åü„ÅÑ„Çà„ÅÜ">
                        <div class="character-image" id="char-img-„Åü„ÅÑ„Çà„ÅÜ">‚òÄÔ∏è</div>
                        <div class="character-name">„Åü„ÅÑ„Çà„ÅÜ</div>
                    </button>
                    <button class="character-button button" data-character="„ÅÇ„Åç„Çâ">
                        <div class="character-image" id="char-img-„ÅÇ„Åç„Çâ">‚≠ê</div>
                        <div class="character-name">„ÅÇ„Åç„Çâ</div>
                    </button>
                    <button class="character-button button" data-character="„ÅÇ„Çã„Åæ">
                        <div class="character-image" id="char-img-„ÅÇ„Çã„Åæ">üå∏</div>
                        <div class="character-name">„ÅÇ„Çã„Åæ</div>
                    </button>
                    <button class="character-button button" data-character="„ÅÑ„Åä„Çä">
                        <div class="character-image" id="char-img-„ÅÑ„Åä„Çä">üå∫</div>
                        <div class="character-name">„ÅÑ„Åä„Çä</div>
                    </button>
                    <button class="character-button button" data-character="„Åó„ÇÖ„ÅÜ„Åî">
                        <div class="character-image" id="char-img-„Åó„ÇÖ„ÅÜ„Åî">üåä</div>
                        <div class="character-name">„Åó„ÇÖ„ÅÜ„Åî</div>
                    </button>
                    <button class="character-button button" data-character="„Åæ„Åª">
                        <div class="character-image" id="char-img-„Åæ„Åª">üåô</div>
                        <div class="character-name">„Åæ„Åª</div>
                    </button>
                    <button class="character-button button" data-character="„Åó„Å•„Åç">
                        <div class="character-image" id="char-img-„Åó„Å•„Åç">üçÄ</div>
                        <div class="character-name">„Åó„Å•„Åç</div>
                    </button>
                    <button class="character-button button" data-character="„ÅÇ„Åï„Å≤">
                        <div class="character-image" id="char-img-„ÅÇ„Åï„Å≤">üåÖ</div>
                        <div class="character-name">„ÅÇ„Åï„Å≤</div>
                    </button>
                    <button class="character-button button" data-character="„Åó„ÇÖ„Çì">
                        <div class="character-image" id="char-img-„Åó„ÇÖ„Çì">üéã</div>
                        <div class="character-name">„Åó„ÇÖ„Çì</div>
                    </button>
                    <button class="character-button button" data-character="„ÅÇ„Å§„Åì">
                        <div class="character-image" id="char-img-„ÅÇ„Å§„Åì">üåª</div>
                        <div class="character-name">„ÅÇ„Å§„Åì</div>
                    </button>
                </div>
                <div class="scroll-hint">‚Üê „Çπ„ÉØ„Ç§„Éó„Åó„Å¶„Ç≠„É£„É©„ÇØ„Çø„Éº„ÇíÈÅ∏Êäû ‚Üí</div>
            </div>
            
            <div style="font-size: 9px; margin: 15px 0 10px 0;">„Å™„Çì„ÅÑ„Å©„Çí„Åà„Çâ„Åº„ÅÜÔºÅ</div>
            <div class="difficulty-select">
                <button class="difficulty-button button selected" data-difficulty="easy">„Åã„Çì„Åü„Çì</button>
                <button class="difficulty-button button" data-difficulty="normal">„Åµ„Å§„ÅÜ</button>
                <button class="difficulty-button button" data-difficulty="hard">„ÇÄ„Åö„Åã„Åó„ÅÑ</button>
                <button class="difficulty-button button" data-difficulty="extreme">„É§„Éê„Ç§</button>
            </div>
            
            <button class="button" onclick="startGame()">„Ç≤„Éº„É†„Åã„ÅÑ„ÅóÔºÅ</button>
            <button class="button" onclick="showStageSelect()">„ÇÇ„Å©„Çã</button>
        </div>
        
        <!-- „Ç≤„Éº„É†ÁîªÈù¢ -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div>„Ç≠„É£„É©: <span id="current-character">„Åü„ÅÑ„Çà„ÅÜ</span></div>
                <div>„Çπ„ÉÜ„Éº„Ç∏: <span id="current-stage">1</span></div>
                <div>Èõ£ÊòìÂ∫¶: <span id="current-difficulty">„Åã„Çì„Åü„Çì</span></div>
            </div>
            
            <canvas id="game-canvas" class="game-canvas" width="350" height="350"></canvas>
            
            <div class="inventory">
                <div class="inventory-item" id="weapon-slot">üó°Ô∏è</div>
            </div>
            
            <div class="controls">
                „Çπ„Éû„ÉõÔºöÁîªÈù¢„Çí„Çπ„ÉØ„Ç§„Éó„Åó„Å¶ÁßªÂãï<br>
                PCÔºöÁü¢Âç∞„Ç≠„Éº„ÅßÁßªÂãï
            </div>
            
            <button class="button" onclick="showStageSelect()">„Çπ„ÉÜ„Éº„Ç∏„Åõ„Çì„Åü„Åè„Å´Êàª„Çã</button>
        </div>
        
        <!-- „ÇØ„É™„Ç¢ÁîªÈù¢ -->
        <div id="clear-screen" class="screen">
            <div class="title">üéâ „Çπ„ÉÜ„Éº„Ç∏„ÇØ„É™„Ç¢ÔºÅ üéâ</div>
            <div id="clear-message" style="margin: 20px 0; font-size: 10px;"></div>
            <div id="new-character" style="margin: 15px 0; font-size: 12px; color: #ffa502;"></div>
            <button class="button" onclick="showStageSelect()">„Å§„Åé„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏</button>
        </div>
        
        <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÈù¢ -->
        <div id="gameover-screen" class="screen">
            <div class="title" style="color: #e74c3c;">üíÄ „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº üíÄ</div>
            <div style="margin: 20px 0; font-size: 10px; color: #e74c3c; line-height: 1.4;">
                Êïµ„Å´„ÇÑ„Çâ„Çå„Å¶„Åó„Åæ„Å£„Åü...<br>
                Ê≠¶Âô®„ÇíÈõÜ„ÇÅ„Å¶„É™„Éô„É≥„Ç∏„Åó„Çà„ÅÜÔºÅ
            </div>
            <button class="button" onclick="restartGame()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
            <button class="button" onclick="showStageSelect()">„Çπ„ÉÜ„Éº„Ç∏„Åõ„Çì„Åü„Åè„Å´Êàª„Çã</button>
        </div>
        
        <!-- „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
        <div id="popup" class="popup">
            <div class="popup-title" id="popup-title">üéâ</div>
            <div class="popup-message" id="popup-message"></div>
            <button class="popup-button" onclick="closePopup()">OK!</button>
        </div>
    </div>

    <script>
        // „Ç≤„Éº„É†Áä∂ÊÖã
        let gameState = {
            currentStage: 1,
            selectedCharacter: '„Åü„ÅÑ„Çà„ÅÜ',
            selectedDifficulty: 'easy',
            unlockedCharacters: ['„Åü„ÅÑ„Çà„ÅÜ'],
            clearedStages: [],
            weaponCount: 0,
            treasureCount: 0
        };

        // ÁîªÂÉè„Éá„Éº„Çø
        const gameImages = {
            characters: {
                '„Åü„ÅÑ„Çà„ÅÜ': null,
                '„ÅÇ„Åç„Çâ': null,
                '„ÅÇ„Çã„Åæ': null,
                '„ÅÑ„Åä„Çä': null,
                '„Åó„ÇÖ„ÅÜ„Åî': null,
                '„Åæ„Åª': null,
                '„Åó„Å•„Åç': null,
                '„ÅÇ„Åï„Å≤': null,
                '„Åó„ÇÖ„Çì': null,
                '„ÅÇ„Å§„Åì': null
            },
            characterSelect: {
                '„Åü„ÅÑ„Çà„ÅÜ': null,
                '„ÅÇ„Åç„Çâ': null,
                '„ÅÇ„Çã„Åæ': null,
                '„ÅÑ„Åä„Çä': null,
                '„Åó„ÇÖ„ÅÜ„Åî': null,
                '„Åæ„Åª': null,
                '„Åó„Å•„Åç': null,
                '„ÅÇ„Åï„Å≤': null,
                '„Åó„ÇÖ„Çì': null,
                '„ÅÇ„Å§„Åì': null
            },
            weapons: {
                sword: null,
                bow: null,
                staff: null
            },
            enemies: {
                ghost: null,
                zombie: null,
                dragon: null
            },
            items: {
                treasure: null,
                friend: null
            }
        };

        // Ë™≠„ÅøËæº„ÅøÊ∏à„ÅøÁîªÂÉè„Çí‰øùÂ≠ò„Åô„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        const loadedImages = {};

        // ÁîªÂÉèË®≠ÂÆöÈñ¢Êï∞Ôºà„Ç≤„Éº„É†ÂÜÖÁî®„Å®„Ç≠„É£„É©ÈÅ∏ÊäûÁî®„ÇíÂàÜÈõ¢Ôºâ
        function setCharacterImage(characterName, gameImagePath, selectImagePath = null) {
            gameImages.characters[characterName] = gameImagePath;
            
            // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏ÊäûÁîªÈù¢Áî®„ÅÆÁîªÂÉè
            const displayImagePath = selectImagePath || gameImagePath;
            gameImages.characterSelect[characterName] = displayImagePath;
            
            const imgElement = document.getElementById(`char-img-${characterName}`);
            if (imgElement && displayImagePath) {
                imgElement.innerHTML = `<img src="${displayImagePath}" alt="${characterName}">`;
            }
            
            // „Ç≤„Éº„É†ÂÜÖÁî®„ÅÆÁîªÂÉè„Çí‰∫ãÂâçË™≠„ÅøËæº„Åø
            if (gameImagePath && !loadedImages[gameImagePath]) {
                const img = new Image();
                img.onload = function() {
                    loadedImages[gameImagePath] = img;
                    console.log('‚úÖ „Ç≠„É£„É©„ÇØ„Çø„ÉºÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', characterName);
                };
                img.onerror = function() {
                    console.log('‚ùå „Ç≠„É£„É©„ÇØ„Çø„ÉºÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó:', gameImagePath);
                };
                img.src = gameImagePath;
            }
            
            // ÈÅ∏ÊäûÁîªÈù¢Áî®„ÅÆÁîªÂÉè„ÇÇ‰∫ãÂâçË™≠„ÅøËæº„ÅøÔºàÂà•ÁîªÂÉè„ÅÆÂ†¥ÂêàÔºâ
            if (selectImagePath && selectImagePath !== gameImagePath && !loadedImages[selectImagePath]) {
                const selectImg = new Image();
                selectImg.onload = function() {
                    loadedImages[selectImagePath] = selectImg;
                    console.log('‚úÖ ÈÅ∏ÊäûÁîªÈù¢Áî®ÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', characterName);
                };
                selectImg.onerror = function() {
                    console.log('‚ùå ÈÅ∏ÊäûÁîªÈù¢Áî®ÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó:', selectImagePath);
                };
                selectImg.src = selectImagePath;
            }
        }

        function setWeaponImage(weaponType, imagePath) {
            gameImages.weapons[weaponType] = imagePath;
        }

        function setEnemyImage(enemyType, imagePath) {
            gameImages.enemies[enemyType] = imagePath;
            
            if (!loadedImages[imagePath]) {
                const img = new Image();
                img.onload = function() {
                    loadedImages[imagePath] = img;
                    console.log('‚úÖ ÊïµÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', enemyType);
                };
                img.onerror = function() {
                    console.log('‚ùå ÊïµÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó:', imagePath);
                };
                img.src = imagePath;
            }
        }

        function setItemImage(itemType, imagePath) {
            gameImages.items[itemType] = imagePath;
            
            if (!loadedImages[imagePath]) {
                const img = new Image();
                img.onload = function() {
                    loadedImages[imagePath] = img;
                    console.log('‚úÖ „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉèË™≠„ÅøËæº„ÅøÂÆå‰∫Ü:', itemType);
                };
                img.onerror = function() {
                    console.log('‚ùå „Ç¢„Ç§„ÉÜ„É†ÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó:', imagePath);
                };
                img.src = imagePath;
            }
        }

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏
        function loadGameData() {
            const saved = localStorage.getItem('mazeGameSave');
            if (saved) {
                gameState = { ...gameState, ...JSON.parse(saved) };
            }
        }

        function saveGameData() {
            localStorage.setItem('mazeGameSave', JSON.stringify(gameState));
        }

        // ÁîªÈù¢ÈÅ∑Áßª
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showTitle() {
            showScreen('title-screen');
        }

        function showStageSelect() {
            showScreen('stage-select');
            updateStageButtons();
        }

        function showCharacterSelect(stage) {
            gameState.currentStage = stage;
            document.getElementById('current-stage').textContent = stage;
            showScreen('character-select');
        }

        // „Çπ„ÉÜ„Éº„Ç∏„Éú„Çø„É≥„ÅÆÊõ¥Êñ∞
        function updateStageButtons() {
            const stageButtons = document.querySelectorAll('.stage-button');
            stageButtons.forEach((button, index) => {
                const stageNumber = index + 1;
                if (stageNumber === 1 || gameState.clearedStages.includes(stageNumber - 1)) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
            });
        }

        // „Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû
        document.querySelectorAll('.character-button').forEach(button => {
            button.addEventListener('click', function() {
                const character = this.dataset.character;
                if (gameState.unlockedCharacters.includes(character)) {
                    document.querySelectorAll('.character-button').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.selectedCharacter = character;
                } else {
                    alert('„Åì„ÅÆ„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅØ„Åæ„Å†„Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„ÇìÔºÅ');
                }
            });
        });

        // Èõ£ÊòìÂ∫¶ÈÅ∏Êäû
        document.querySelectorAll('.difficulty-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.difficulty-button').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedDifficulty = this.dataset.difficulty;
            });
        });

        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            document.getElementById('current-character').textContent = gameState.selectedCharacter;
            document.getElementById('current-stage').textContent = gameState.currentStage;
            document.getElementById('current-difficulty').textContent = 
                document.querySelector('.difficulty-button.selected').textContent;
            
            showScreen('game-screen');
            initializeGame();
        }

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        let player = { x: 1, y: 1 };
        let friend = { x: 18, y: 18 };
        let treasures = [];
        let movingEnemies = [];
        let gameRunning = false;
        let lastEnemyMove = 0;

        // Ëø∑Ë∑Ø„Éá„Éº„Çø
        const maze = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
            [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,1,0,1],
            [1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,1,0,1,1,1,1,0,1,1,1,0,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,1,0,1],
            [1,1,1,0,1,1,1,1,1,0,1,0,1,1,1,1,0,1,0,1],
            [1,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1],
            [1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
            [1,1,0,1,1,1,1,0,1,1,1,1,0,1,0,1,0,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        function initializeGame() {
            player = { x: 1, y: 1 };
            friend = { x: 18, y: 18 };
            
            // Èõ£ÊòìÂ∫¶„Å´„Çà„ÇãÊïµ„ÅÆÊï∞
            let enemyCount;
            switch(gameState.selectedDifficulty) {
                case 'easy': enemyCount = 3; break;
                case 'normal': enemyCount = 4; break;
                case 'hard': enemyCount = 5; break;
                case 'extreme': enemyCount = 6; break;
                default: enemyCount = 3;
            }
            
            // Êïµ„ÅÆÈÖçÁΩÆ
            movingEnemies = [];
            const enemyPositions = [
                { x: 7, y: 7, dx: 1, dy: 0 },
                { x: 15, y: 10, dx: 0, dy: 1 },
                { x: 5, y: 15, dx: -1, dy: 0 },
                { x: 12, y: 3, dx: 1, dy: 0 },
                { x: 3, y: 12, dx: 0, dy: -1 },
                { x: 17, y: 6, dx: -1, dy: 0 },
                { x: 8, y: 16, dx: 0, dy: 1 },
                { x: 14, y: 14, dx: 1, dy: 0 }
            ];
            
            for (let i = 0; i < Math.min(enemyCount, enemyPositions.length); i++) {
                movingEnemies.push({ ...enemyPositions[i] });
            }
            
            // ÂÆùÁÆ±„ÅÆÈÖçÁΩÆ
            treasures = [];
            const treasurePositions = [
                { x: 10, y: 5, collected: false },
                { x: 3, y: 8, collected: false },
                { x: 16, y: 3, collected: false },
                { x: 6, y: 12, collected: false },
                { x: 13, y: 7, collected: false },
                { x: 2, y: 16, collected: false },
                { x: 17, y: 12, collected: false },
                { x: 9, y: 14, collected: false }
            ];
            
            for (let i = 0; i < enemyCount; i++) {
                if (treasurePositions[i]) {
                    treasures.push({ ...treasurePositions[i] });
                }
            }
            
            gameState.weaponCount = 0;
            gameState.treasureCount = 0;
            gameRunning = true;
            lastEnemyMove = Date.now();
            updateInventory();
            drawGame();
            
            moveEnemies();
        }

        function drawGame() {
            ctx.fillStyle = '#0f0f23';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cellSize = Math.min(canvas.width / 20, canvas.height / 20);

            // Ëø∑Ë∑Ø„ÇíÊèèÁîª
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    if (maze[y][x] === 1) {
                        ctx.fillStyle = '#2d3436';
                        ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                        ctx.fillStyle = '#636e72';
                        ctx.fillRect(x * cellSize + 2, y * cellSize + 2, cellSize - 4, cellSize - 4);
                    }
                }
            }

            // ÂÆùÁÆ±„ÇíÊèèÁîª
            treasures.forEach(treasure => {
                if (!treasure.collected) {
                    const treasureImagePath = gameImages.items.treasure;
                    if (treasureImagePath && loadedImages[treasureImagePath]) {
                        ctx.drawImage(loadedImages[treasureImagePath], treasure.x * cellSize, treasure.y * cellSize, cellSize, cellSize);
                    } else {
                        drawDefaultTreasure(treasure.x, treasure.y, cellSize);
                    }
                }
            });

            // Âãï„ÅèÊïµ„ÇíÊèèÁîª
            movingEnemies.forEach((enemy, index) => {
                const enemyImagePath = gameImages.enemies.zombie;
                if (enemyImagePath && loadedImages[enemyImagePath]) {
                    ctx.drawImage(loadedImages[enemyImagePath], enemy.x * cellSize, enemy.y * cellSize, cellSize, cellSize);
                } else {
                    ctx.fillStyle = '#e84118';
                    ctx.fillRect(enemy.x * cellSize + 2, enemy.y * cellSize + 2, cellSize - 4, cellSize - 4);
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = `${cellSize * 0.6}px monospace`;
                    ctx.textAlign = 'center';
                    ctx.fillText('üëª', enemy.x * cellSize + cellSize/2, enemy.y * cellSize + cellSize/2 + 4);
                }
            });

            // ÂèãÈÅî„ÇíÊèèÁîªÔºà„Ç¥„Éº„É´Âú∞ÁÇπÔºâ
            if (gameImages.items.friend && loadedImages[gameImages.items.friend]) {
                ctx.drawImage(loadedImages[gameImages.items.friend], friend.x * cellSize, friend.y * cellSize, cellSize, cellSize);
            } else {
                ctx.fillStyle = '#00b894';
                ctx.fillRect(friend.x * cellSize + 2, friend.y * cellSize + 2, cellSize - 4, cellSize - 4);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = `${cellSize * 0.6}px monospace`;
                ctx.textAlign = 'center';
                ctx.fillText('üë•', friend.x * cellSize + cellSize/2, friend.y * cellSize + cellSize/2 + 4);
            }

            // „Éó„É¨„Ç§„É§„Éº„ÇíÊèèÁîª
            const playerImagePath = gameImages.characters[gameState.selectedCharacter];
            if (playerImagePath && loadedImages[playerImagePath]) {
                ctx.drawImage(loadedImages[playerImagePath], player.x * cellSize, player.y * cellSize, cellSize, cellSize);
            } else {
                drawDefaultPlayer(cellSize);
            }
        }
        
        function drawDefaultTreasure(x, y, cellSize) {
            ctx.fillStyle = '#fdcb6e';
            ctx.fillRect(x * cellSize + 2, y * cellSize + 2, cellSize - 4, cellSize - 4);
            ctx.fillStyle = '#e17055';
            ctx.fillRect(x * cellSize + 4, y * cellSize + 4, cellSize - 8, cellSize - 8);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = `${cellSize * 0.6}px monospace`;
            ctx.textAlign = 'center';
            ctx.fillText('üí∞', x * cellSize + cellSize/2, y * cellSize + cellSize/2 + 4);
        }
        
        function drawDefaultPlayer(cellSize) {
            ctx.fillStyle = '#74b9ff';
            ctx.fillRect(player.x * cellSize + 3, player.y * cellSize + 3, cellSize - 6, cellSize - 6);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = `${cellSize * 0.6}px monospace`;
            ctx.textAlign = 'center';
            ctx.fillText('üòä', player.x * cellSize + cellSize/2, player.y * cellSize + cellSize/2 + 4);
        }

        function movePlayer(dx, dy) {
            if (!gameRunning) return;

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (maze[newY] && maze[newY][newX] !== 1) {
                player.x = newX;
                player.y = newY;

                // ÂÆùÁÆ±„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                treasures.forEach((treasure, index) => {
                    if (!treasure.collected && player.x === treasure.x && player.y === treasure.y) {
                        treasure.collected = true;
                        gameState.weaponCount++;
                        gameState.treasureCount++;
                        updateInventory();
                        
                        const weapons = ['üó°Ô∏è Ââ£', 'üèπ Âºì', 'üî• „Éï„Ç°„Ç§„Ç¢„Éú„Éº„É´'];
                        const randomWeapon = weapons[Math.floor(Math.random() * weapons.length)];
                        
                        showPopup(`${randomWeapon}„Çí„Ç≤„ÉÉ„ÉàÔºÅ`, `${randomWeapon}„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ<br>„Åì„Çå„ÅßÊïµ„ÇíÂÄí„Åõ„Çã„ÇàÔºÅ`);
                    }
                });

                // Âãï„ÅèÊïµ„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                for (let i = movingEnemies.length - 1; i >= 0; i--) {
                    const enemy = movingEnemies[i];
                    if (player.x === enemy.x && player.y === enemy.y) {
                        if (gameState.weaponCount > 0) {
                            movingEnemies.splice(i, 1);
                            gameState.weaponCount--;
                            updateInventory();
                            showPopup('‚öîÔ∏è Êïµ„ÇíÂÄí„Åó„ÅüÔºÅ', `Êïµ„Çí„ÇÑ„Å£„Å§„Åë„ÅüÔºÅ<br>Ê≠¶Âô®„Åå1„Å§Ê∏õ„Å£„Åü„Çà<br>ÊÆã„ÇäÊ≠¶Âô®Ôºö${gameState.weaponCount}ÂÄã`);
                        } else {
                            gameRunning = false;
                            showPopup('üíÄ „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÔºÅ', 'Ê≠¶Âô®„Åå„Å™„ÅÑ„Å®Êïµ„Å´„ÇÑ„Çâ„Çå„Å°„ÇÉ„Å£„ÅüÔºÅ<br>Ê¨°„ÅØ„ÇÇ„Å£„Å®Ê∞ó„Çí„Å§„Åë„Çà„ÅÜÔºÅ', () => {
                                showGameOver();
                            });
                            return;
                        }
                        break;
                    }
                }

                // ÂèãÈÅîÔºà„Ç¥„Éº„É´Ôºâ„Å®„ÅÆË°ùÁ™ÅÂà§ÂÆö
                if (player.x === friend.x && player.y === friend.y) {
                    gameRunning = false;
                    
                    const newFriend = getRandomCharacter();
                    if (newFriend && !gameState.unlockedCharacters.includes(newFriend)) {
                        gameState.unlockedCharacters.push(newFriend);
                        showPopup('üéâ ÂèãÈÅî„Å´‰ºö„Åà„ÅüÔºÅ', `${newFriend}„Å´‰ºö„Åà„ÅüÔºÅ„ÇÑ„Å£„Åü„ÉºÔºÅ<br>Êñ∞„Åó„ÅÑÂèãÈÅî„Çí„Ç≤„ÉÉ„Éà„Åó„Åü„ÇàÔºÅ`, () => {
                            showClearScreen(newFriend);
                        });
                    } else {
                        showPopup('üéâ ÂèãÈÅî„Å´‰ºö„Åà„ÅüÔºÅ', 'ÂèãÈÅî„Å´‰ºö„Åà„ÅüÔºÅ„ÇÑ„Å£„Åü„ÉºÔºÅ', () => {
                            showClearScreen();
                        });
                    }
                    
                    gameState.clearedStages.push(gameState.currentStage);
                    saveGameData();
                }

                drawGame();
            }
        }

        function getRandomCharacter() {
            const allCharacters = ['„Åü„ÅÑ„Çà„ÅÜ', '„ÅÇ„Åç„Çâ', '„ÅÇ„Çã„Åæ', '„ÅÑ„Åä„Çä', '„Åó„ÇÖ„ÅÜ„Åî', 
                                   '„Åæ„Åª', '„Åó„Å•„Åç', '„ÅÇ„Åï„Å≤', '„Åó„ÇÖ„Çì', '„ÅÇ„Å§„Åì'];
            const locked = allCharacters.filter(char => !gameState.unlockedCharacters.includes(char));
            return locked.length > 0 ? locked[Math.floor(Math.random() * locked.length)] : null;
        }

        // Êïµ„ÅÆÁßªÂãïÂá¶ÁêÜ
        function moveEnemies() {
            if (!gameRunning) return;
            
            let enemySpeed;
            switch(gameState.selectedDifficulty) {
                case 'easy': enemySpeed = 800; break;
                case 'normal': enemySpeed = 500; break;
                case 'hard': enemySpeed = 300; break;
                case 'extreme': enemySpeed = 150; break;
                default: enemySpeed = 500;
            }
            
            const now = Date.now();
            if (now - lastEnemyMove > enemySpeed) {
                movingEnemies.forEach(enemy => {
                    const newX = enemy.x + enemy.dx;
                    const newY = enemy.y + enemy.dy;
                    
                    if (!maze[newY] || maze[newY][newX] === 1 || newX < 0 || newX >= 20 || newY < 0 || newY >= 20) {
                        const directions = [
                            { dx: 1, dy: 0 },
                            { dx: -1, dy: 0 },
                            { dx: 0, dy: 1 },
                            { dx: 0, dy: -1 }
                        ];
                        const randomDirection = directions[Math.floor(Math.random() * directions.length)];
                        enemy.dx = randomDirection.dx;
                        enemy.dy = randomDirection.dy;
                    } else {
                        enemy.x = newX;
                        enemy.y = newY;
                    }
                });
                
                lastEnemyMove = now;
                drawGame();
            }
            
            if (gameRunning) {
                requestAnimationFrame(moveEnemies);
            }
        }

        // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
        function showPopup(title, message, callback = null) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').innerHTML = message;
            document.getElementById('popup').classList.add('show');
            
            window.popupCallback = callback;
        }

        function closePopup() {
            document.getElementById('popup').classList.remove('show');
            
            if (window.popupCallback) {
                setTimeout(window.popupCallback, 100);
                window.popupCallback = null;
            }
        }

        function updateInventory() {
            const weaponSlot = document.getElementById('weapon-slot');
            
            if (gameState.weaponCount > 0) {
                weaponSlot.classList.add('has-item');
                weaponSlot.textContent = `üó°Ô∏è${gameState.weaponCount}`;
            } else {
                weaponSlot.classList.remove('has-item');
                weaponSlot.textContent = 'üîí';
            }
        }

        function showClearScreen(newCharacter = null) {
            const message = document.getElementById('clear-message');
            const newCharEl = document.getElementById('new-character');
            
            message.textContent = `„Çπ„ÉÜ„Éº„Ç∏ ${gameState.currentStage} „Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ`;
            
            if (newCharacter) {
                newCharEl.textContent = `üéâ „ÅÇ„Åü„Çâ„Åó„ÅÑÂèãÈÅî„Äå${newCharacter}„Äç„Çí„Ç≤„ÉÉ„Éà„Åó„ÅüÔºÅ`;
                newCharEl.style.display = 'block';
            } else {
                newCharEl.style.display = 'none';
            }
            
            showScreen('clear-screen');
        }

        function showGameOver() {
            showScreen('gameover-screen');
        }

        function restartGame() {
            showScreen('game-screen');
            initializeGame();
        }

        // „Ç¢„É≥„É≠„ÉÉ„ÇØ„Åï„Çå„Åü„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
        function updateCharacterButtons() {
            document.querySelectorAll('.character-button').forEach(button => {
                const character = button.dataset.character;
                if (gameState.unlockedCharacters.includes(character)) {
                    button.disabled = false;
                    button.style.opacity = '1';
                } else {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                }
            });
        }

        // „Ç≠„Éº„Éú„Éº„Éâ„Ç§„Éô„É≥„Éà
        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
            }
        });

        // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„ÉàÔºà„Çπ„Éû„Éº„Éà„Éï„Ç©„É≥Áî®Ôºâ- ÁîªÈù¢„ÅÆÊè∫„Çå„ÇíÈò≤Ê≠¢
        let touchStartX, touchStartY;

        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            touchStartX = touch.clientX - rect.left;
            touchStartY = touch.clientY - rect.top;
        }, { passive: false });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!touchStartX || !touchStartY) return;

            const touch = e.changedTouches[0];
            const rect = canvas.getBoundingClientRect();
            const touchEndX = touch.clientX - rect.left;
            const touchEndY = touch.clientY - rect.top;

            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;

            // ÊúÄÂ∞èÁßªÂãïË∑ùÈõ¢„ÇíË®≠ÂÆö
            const minDistance = 20;
            if (Math.abs(dx) > minDistance || Math.abs(dy) > minDistance) {
                if (Math.abs(dx) > Math.abs(dy)) {
                    movePlayer(dx > 0 ? 1 : -1, 0);
                } else {
                    movePlayer(0, dy > 0 ? 1 : -1);
                }
            }
        }, { passive: false });

        // ÂÖ®‰Ωì„ÅÆ„Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÇíÂà∂Âæ°
        document.addEventListener('touchmove', function(e) {
            if (e.target === canvas || e.target.closest('.character-select')) {
                return; // „Ç≠„É£„É≥„Éê„Çπ„Å®„Ç≠„É£„É©„ÇØ„Çø„ÉºÈÅ∏Êäû„ÅÆ„Çπ„ÇØ„É≠„Éº„É´„ÅØË®±ÂèØ
            }
            e.preventDefault();
        }, { passive: false });

        // „Ç≤„Éº„É†ÂàùÊúüÂåñÊôÇ„Å´„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        loadGameData();

        // ÂàùÊúüÂåñ
        updateCharacterButtons();
        updateStageButtons();

        // ÁîªÂÉè„ÇíË®≠ÂÆö
        setItemImage('treasure', 'images/items/treasure_red_gold.png');
        setCharacterImage('„Åü„ÅÑ„Çà„ÅÜ', 'images/characters/taiyou_small.png', 'images/characters/taiyou_large.png');
        setEnemyImage('zombie', 'images/enemies/character_monster_zombie_02_green.png');
    </script>
</body>
</html>