<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ”ã‚¯ã‚»ãƒ« ã‚ã„ã‚ã‚²ãƒ¼ãƒ </title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 10px;
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        
        .game-container {
            width: 100%;
            max-width: 500px;
            background: #0f0f23;
            border: 3px solid #00ff00;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .title {
            font-size: 18px;
            color: #00ff00;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #006600;
        }
        
        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
            box-shadow: 0 4px 0 #cc4125;
            touch-action: manipulation;
        }
        
        .button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc4125;
        }
        
        .button:active {
            transform: translateY(4px);
            box-shadow: none;
        }
        
        .stage-button {
            background: linear-gradient(45deg, #4834d4, #686de0);
            box-shadow: 0 4px 0 #3742fa;
            margin: 5px;
            padding: 10px 15px;
            font-size: 9px;
        }
        
        .stage-button:hover {
            box-shadow: 0 2px 0 #3742fa;
        }
        
        .stage-button:disabled {
            background: #666;
            box-shadow: 0 4px 0 #333;
            opacity: 0.5;
        }
        
        .stage-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .character-select-container {
            margin: 20px 0;
        }
        
        .character-select {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .character-select::-webkit-scrollbar {
            display: none;
        }
        
        .character-button {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            box-shadow: 0 4px 0 #2f3542;
            font-size: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            min-height: 120px;
            flex-shrink: 0;
            scroll-snap-align: center;
            border-radius: 8px;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .character-button.selected {
            background: linear-gradient(45deg, #ffa502, #ff6348);
            box-shadow: 0 4px 0 #ff4757;
            transform: scale(1.05);
        }
        
        .character-button:disabled {
            opacity: 0.5;
            transform: none;
        }

        .character-image {
            width: 60px;
            height: 60px;
            background: #ffffff;
            border: 2px solid #2f3542;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            image-rendering: pixelated;
        }

        .character-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }

        .character-name {
            font-size: 8px;
            text-align: center;
            line-height: 1.2;
            color: #ffffff;
            text-shadow: 1px 1px 0px #000000;
        }
        
        .difficulty-select {
            margin: 15px 0;
        }
        
        .difficulty-button {
            background: linear-gradient(45deg, #5f27cd, #a55eea);
            font-size: 9px;
            padding: 8px 15px;
            margin: 4px;
        }
        
        .difficulty-button.selected {
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
        }
        
        .game-canvas {
            border: 2px solid #00ff00;
            background: #1a1a2e;
            margin: 15px 0;
            image-rendering: pixelated;
            max-width: 100%;
            height: auto;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 8px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .inventory {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .inventory-item {
            width: 35px;
            height: 35px;
            background: #2f3542;
            border: 2px solid #57606f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border-radius: 4px;
        }
        
        .inventory-item.has-item {
            background: #ffa502;
            border-color: #ff9ff3;
        }
        
        .controls {
            margin: 10px 0;
            font-size: 7px;
            color: #a4b0be;
            line-height: 1.3;
        }
        
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(45deg, #0984e3, #74b9ff);
            border: 4px solid #ffffff;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            max-width: 280px;
            display: none;
        }
        
        .popup.show {
            display: block;
            animation: popupBounce 0.5s ease-out;
        }
        
        @keyframes popupBounce {
            0% { transform: translate(-50%, -50%) scale(0.3); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }
        
        .popup-title {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0px #0984e3;
        }
        
        .popup-message {
            font-size: 10px;
            color: #ffffff;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .popup-button {
            background: linear-gradient(45deg, #00b894, #55efc4);
            color: white;
            border: none;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 9px;
            cursor: pointer;
            border-radius: 6px;
            box-shadow: 0 4px 0 #00a085;
            touch-action: manipulation;
        }
        
        .popup-button:hover {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #00a085;
        }
        
        .scroll-hint {
            font-size: 7px;
            color: #a4b0be;
            margin-top: 5px;
        }
        
        /* ã‚¹ãƒãƒ›å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (max-width: 600px) {
            body {
                padding: 5px;
                min-height: 100vh;
                overflow-x: hidden;
            }
            
            .game-container {
                max-width: 100%;
                padding: 10px;
                border-width: 2px;
            }
            
            .title {
                font-size: 14px;
                margin-bottom: 15px;
            }
            
            .game-canvas {
                width: 100%;
                max-width: 350px;
                height: auto;
            }
            
            .character-button {
                min-width: 80px;
                min-height: 100px;
            }
            
            .character-image {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
        <div id="title-screen" class="screen active">
            <div class="title">ğŸ° ãƒ”ã‚¯ã‚»ãƒ« ã‚ã„ã‚ã‚²ãƒ¼ãƒ  ğŸ°</div>
            <div style="margin: 20px 0; font-size: 10px; line-height: 1.4;">
                ã‚ã„ã‚ã‚’ã‚¯ãƒªã‚¢ã—ã¦<br>
                ã¤ã‚ˆã„æ•µã‚’å€’ãã†ï¼
            </div>
            <button class="button" onclick="showStageSelect()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
        
        <!-- ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠç”»é¢ -->
        <div id="stage-select" class="screen">
            <div class="title">ã‚¹ãƒ†ãƒ¼ã‚¸ã›ã‚“ãŸã</div>
            <div class="stage-grid">
                <button class="stage-button button" onclick="showCharacterSelect(1)">ã‚¹ãƒ†ãƒ¼ã‚¸ 1</button>
                <button class="stage-button button" onclick="showCharacterSelect(2)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 2</button>
                <button class="stage-button button" onclick="showCharacterSelect(3)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 3</button>
                <button class="stage-button button" onclick="showCharacterSelect(4)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 4</button>
                <button class="stage-button button" onclick="showCharacterSelect(5)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 5</button>
                <button class="stage-button button" onclick="showCharacterSelect(6)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 6</button>
                <button class="stage-button button" onclick="showCharacterSelect(7)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 7</button>
                <button class="stage-button button" onclick="showCharacterSelect(8)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 8</button>
                <button class="stage-button button" onclick="showCharacterSelect(9)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 9</button>
                <button class="stage-button button" onclick="showCharacterSelect(10)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 10</button>
                <button class="stage-button button" onclick="showCharacterSelect(11)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 11</button>
                <button class="stage-button button" onclick="showCharacterSelect(12)" disabled>ã‚¹ãƒ†ãƒ¼ã‚¸ 12</button>
            </div>
            <button class="button" onclick="showTitle()">ã‚‚ã©ã‚‹</button>
        </div>
        
        <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ»é›£æ˜“åº¦é¸æŠç”»é¢ -->
        <div id="character-select" class="screen">
            <div class="title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ & ãªã‚“ã„ã©</div>
            <div style="font-size: 9px; margin-bottom: 10px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’ãˆã‚‰ã¼ã†ï¼</div>
            <div class="character-select-container">
                <div class="character-select">
                    <button class="character-button button selected" data-character="ãŸã„ã‚ˆã†">
                        <div class="character-image" id="char-img-ãŸã„ã‚ˆã†">â˜€ï¸</div>
                        <div class="character-name">ãŸã„ã‚ˆã†</div>
                    </button>
                    <button class="character-button button" data-character="ã‚ãã‚‰">
                        <div class="character-image" id="char-img-ã‚ãã‚‰">â­</div>
                        <div class="character-name">ã‚ãã‚‰</div>
                    </button>
                    <button class="character-button button" data-character="ã‚ã‚‹ã¾">
                        <div class="character-image" id="char-img-ã‚ã‚‹ã¾">ğŸŒ¸</div>
                        <div class="character-name">ã‚ã‚‹ã¾</div>
                    </button>
                    <button class="character-button button" data-character="ã„ãŠã‚Š">
                        <div class="character-image" id="char-img-ã„ãŠã‚Š">ğŸŒº</div>
                        <div class="character-name">ã„ãŠã‚Š</div>
                    </button>
                    <button class="character-button button" data-character="ã—ã‚…ã†ã”">
                        <div class="character-image" id="char-img-ã—ã‚…ã†ã”">ğŸŒŠ</div>
                        <div class="character-name">ã—ã‚…ã†ã”</div>
                    </button>
                    <button class="character-button button" data-character="ã¾ã»">
                        <div class="character-image" id="char-img-ã¾ã»">ğŸŒ™</div>
                        <div class="character-name">ã¾ã»</div>
                    </button>
                    <button class="character-button button" data-character="ã—ã¥ã">
                        <div class="character-image" id="char-img-ã—ã¥ã">ğŸ€</div>
                        <div class="character-name">ã—ã¥ã</div>
                    </button>
                    <button class="character-button button" data-character="ã‚ã•ã²">
                        <div class="character-image" id="char-img-ã‚ã•ã²">ğŸŒ…</div>
                        <div class="character-name">ã‚ã•ã²</div>
                    </button>
                    <button class="character-button button" data-character="ã—ã‚…ã‚“">
                        <div class="character-image" id="char-img-ã—ã‚…ã‚“">ğŸ‹</div>
                        <div class="character-name">ã—ã‚…ã‚“</div>
                    </button>
                    <button class="character-button button" data-character="ã‚ã¤ã“">
                        <div class="character-image" id="char-img-ã‚ã¤ã“">ğŸŒ»</div>
                        <div class="character-name">ã‚ã¤ã“</div>
                    </button>
                </div>
                <div class="scroll-hint">â† ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’é¸æŠ â†’</div>
            </div>
            
            <div style="font-size: 9px; margin: 15px 0 10px 0;">ãªã‚“ã„ã©ã‚’ãˆã‚‰ã¼ã†ï¼</div>
            <div class="difficulty-select">
                <button class="difficulty-button button selected" data-difficulty="easy">ã‹ã‚“ãŸã‚“</button>
                <button class="difficulty-button button" data-difficulty="normal">ãµã¤ã†</button>
                <button class="difficulty-button button" data-difficulty="hard">ã‚€ãšã‹ã—ã„</button>
                <button class="difficulty-button button" data-difficulty="extreme">ãƒ¤ãƒã‚¤</button>
            </div>
            
            <button class="button" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‹ã„ã—ï¼</button>
            <button class="button" onclick="showStageSelect()">ã‚‚ã©ã‚‹</button>
        </div>
        
        <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div>ã‚­ãƒ£ãƒ©: <span id="current-character">ãŸã„ã‚ˆã†</span></div>
                <div>ã‚¹ãƒ†ãƒ¼ã‚¸: <span id="current-stage">1</span></div>
                <div>é›£æ˜“åº¦: <span id="current-difficulty">ã‹ã‚“ãŸã‚“</span></div>
            </div>
            
            <canvas id="game-canvas" class="game-canvas" width="350" height="350"></canvas>
            
            <div class="inventory">
                <div class="inventory-item" id="weapon-slot">ğŸ—¡ï¸</div>
            </div>
            
            <div class="controls">
                ã‚¹ãƒãƒ›ï¼šç”»é¢ã‚’ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦ç§»å‹•<br>
                PCï¼šçŸ¢å°ã‚­ãƒ¼ã§ç§»å‹•
            </div>
            
            <button class="button" onclick="showStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸ã›ã‚“ãŸãã«æˆ»ã‚‹</button>
        </div>
        
        <!-- ã‚¯ãƒªã‚¢ç”»é¢ -->
        <div id="clear-screen" class="screen">
            <div class="title">ğŸ‰ ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ ğŸ‰</div>
            <div id="clear-message" style="margin: 20px 0; font-size: 10px;"></div>
            <div id="new-character" style="margin: 15px 0; font-size: 12px; color: #ffa502;"></div>
            <button class="button" onclick="showStageSelect()">ã¤ãã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸</button>
        </div>
        
        <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
        <div id="gameover-screen" class="screen">
            <div class="title" style="color: #e74c3c;">ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ğŸ’€</div>
            <div style="margin: 20px 0; font-size: 10px; color: #e74c3c; line-height: 1.4;">
                æ•µã«ã‚„ã‚‰ã‚Œã¦ã—ã¾ã£ãŸ...<br>
                æ­¦å™¨ã‚’é›†ã‚ã¦ãƒªãƒ™ãƒ³ã‚¸ã—ã‚ˆã†ï¼
            </div>
            <button class="button" onclick="restartGame()">ã‚‚ã†ã„ã¡ã©</button>
            <button class="button" onclick="showStageSelect()">ã‚¹ãƒ†ãƒ¼ã‚¸ã›ã‚“ãŸãã«æˆ»ã‚‹</button>
        </div>
        
        <!-- ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="popup" class="popup">
            <div class="popup-title" id="popup-title">ğŸ‰</div>
            <div class="popup-message" id="popup-message"></div>
            <button class="popup-button" onclick="closePopup()">OK!</button>
        </div>
    </div>

    <script>
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let gameState = {
            currentStage: 1,
            selectedCharacter: 'ãŸã„ã‚ˆã†',
            selectedDifficulty: 'easy',
            unlockedCharacters: ['ãŸã„ã‚ˆã†'],
            clearedStages: [],
            weaponCount: 0,
            treasureCount: 0
        };

        // ç”»åƒãƒ‡ãƒ¼ã‚¿
        const gameImages = {
            characters: {
                'ãŸã„ã‚ˆã†': null,
                'ã‚ãã‚‰': null,
                'ã‚ã‚‹ã¾': null,
                'ã„ãŠã‚Š': null,
                'ã—ã‚…ã†ã”': null,
                'ã¾ã»': null,
                'ã—ã¥ã': null,
                'ã‚ã•ã²': null,
                'ã—ã‚…ã‚“': null,
                'ã‚ã¤ã“': null
            },
            characterSelect: {
                'ãŸã„ã‚ˆã†': null,
                'ã‚ãã‚‰': null,
                'ã‚ã‚‹ã¾': null,
                'ã„ãŠã‚Š': null,
                'ã—ã‚…ã†ã”': null,
                'ã¾ã»': null,
                'ã—ã¥ã': null,
                'ã‚ã•ã²': null,
                'ã—ã‚…ã‚“': null,
                'ã‚ã¤ã“': null
            },
            weapons: {
                sword: null,
                bow: null,
                staff: null
            },
            enemies: {
                ghost: null,
                zombie: null,
                dragon: null
            },
            items: {
                treasure: null,
                friend: null
            }
        };

        // èª­ã¿è¾¼ã¿æ¸ˆã¿ç”»åƒã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        const loadedImages = {};

        // ç”»åƒè¨­å®šé–¢æ•°ï¼ˆã‚²ãƒ¼ãƒ å†…ç”¨ã¨ã‚­ãƒ£ãƒ©é¸æŠç”¨ã‚’åˆ†é›¢ï¼‰
        function setCharacterImage(characterName, gameImagePath, selectImagePath = null) {
            gameImages.characters[characterName] = gameImagePath;
            
            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ç”¨ã®ç”»åƒ
            const displayImagePath = selectImagePath || gameImagePath;
            gameImages.characterSelect[characterName] = displayImagePath;
            
            const imgElement = document.getElementById(`char-img-${characterName}`);
            if (imgElement && displayImagePath) {
                imgElement.innerHTML = `<img src="${displayImagePath}" alt="${characterName}">`;
            }
            
            // ã‚²ãƒ¼ãƒ å†…ç”¨ã®ç”»åƒã‚’äº‹å‰èª­ã¿è¾¼ã¿
            if (gameImagePath && !loadedImages[gameImagePath]) {
                const img = new Image();
                img.onload = function() {
                    loadedImages[gameImagePath] = img;
                    console.log('âœ… ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†:', characterName);
                };
                img.onerror = function() {
                    console.log('âŒ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—:', gameImagePath);
                };
                img.src = gameImagePath;
            }
            
            // é¸æŠç”»é¢ç”¨ã®ç”»åƒã‚‚äº‹å‰èª­ã¿è¾¼ã¿ï¼ˆåˆ¥ç”»åƒã®å ´åˆï¼‰
            if (selectImagePath && selectImagePath !== gameImagePath && !loadedImages[selectImagePath]) {
                const selectImg = new Image();
                selectImg.onload = function() {
                    loadedImages[selectImagePath] = selectImg;
                    console.log('âœ… é¸æŠç”»é¢ç”¨ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†:', characterName);
                };
                selectImg.onerror = function() {
                    console.log('âŒ é¸æŠç”»é¢ç”¨ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—:', selectImagePath);
                };
                selectImg.src = selectImagePath;
            }
        }

        function setWeaponImage(weaponType, imagePath) {
            gameImages.weapons[weaponType] = imagePath;
        }

        function setEnemyImage(enemyType, imagePath) {
            gameImages.enemies[enemyType] = imagePath;
            
            if (!loadedImages[imagePath]) {
                const img = new Image();
                img.onload = function() {
                    loadedImages[imagePath] = img;
                    console.log('âœ… æ•µç”»åƒèª­ã¿è¾¼ã¿å®Œäº†:', enemyType);
                };
                img.onerror = function() {
                    console.log('âŒ æ•µç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—:', imagePath);
                };
                img.src = imagePath;
            }
        }

        function setItemImage(itemType, imagePath) {
            gameImages.items[itemType] = imagePath;
            
            if (!loadedImages[imagePath]) {
                const img = new Image();
                img.onload = function() {
                    loadedImages[imagePath] = img;
                    console.log('âœ… ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒèª­ã¿è¾¼ã¿å®Œäº†:', itemType);
                };
                img.onerror = function() {
                    console.log('âŒ ã‚¢ã‚¤ãƒ†ãƒ ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—:', imagePath);
                };
                img.src = imagePath;
            }
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
        function loadGameData() {
            const saved = localStorage.getItem('mazeGameSave');
            if (saved) {
                gameState = { ...gameState, ...JSON.parse(saved) };
            }
        }

        function saveGameData() {
            localStorage.setItem('mazeGameSave', JSON.stringify(gameState));
        }

        // ç”»é¢é·ç§»
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showTitle() {
            showScreen('title-screen');
        }

        function showStageSelect() {
            showScreen('stage-select');
            updateStageButtons();
        }

        function showCharacterSelect(stage) {
            gameState.currentStage = stage;
            document.getElementById('current-stage').textContent = stage;
            showScreen('character-select');
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateStageButtons() {
            const stageButtons = document.querySelectorAll('.stage-button');
            stageButtons.forEach((button, index) => {
                const stageNumber = index + 1;
                if (stageNumber === 1 || gameState.clearedStages.includes(stageNumber - 1)) {
                    button.disabled = false;
                } else {
                    button.disabled = true;
                }
            });
        }

        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ
        document.querySelectorAll('.character-button').forEach(button => {
            button.addEventListener('click', function() {
                const character = this.dataset.character;
                if (gameState.unlockedCharacters.includes(character)) {
                    document.querySelectorAll('.character-button').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.selectedCharacter = character;
                } else {
                    alert('ã“ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯ã¾ã ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼');
                }
            });
        });

        // é›£æ˜“åº¦é¸æŠ
        document.querySelectorAll('.difficulty-button').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.difficulty-button').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                gameState.selectedDifficulty = this.dataset.difficulty;
            });
        });

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            document.getElementById('current-character').textContent = gameState.selectedCharacter;
            document.getElementById('current-stage').textContent = gameState.currentStage;
            document.getElementById('current-difficulty').textContent = 
                document.querySelector('.difficulty-button.selected').textContent;
            
            showScreen('game-screen');
            initializeGame();
        }

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');

        let player = { x: 1, y: 1 };
        let friend = { x: 18, y: 18 };
        let treasures = [];
        let movingEnemies = [];
        let gameRunning = false;
        let lastEnemyMove = 0;

        // è¿·è·¯ãƒ‡ãƒ¼ã‚¿
        const maze = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],
            [1,0,1,0,1,0,1,1,0,1,0,1,1,0,1,0,1,1,0,1],
            [1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,1,0,1,1,1,1,0,1,1,1,0,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,1,0,1],
            [1,1,1,0,1,1,1,1,1,0,1,0,1,1,1,1,0,1,0,1],
            [1,0,0,0,0,0,0,0,1,0,1,0,1,0,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,0,1,0,1,0,1,0,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,0,1],
            [1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1],
            [1,1,0,1,1,1,1,0,1,1,1,1,0,1,0,1,0,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1],
            [1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        function initializeGame() {
            player = { x: 1, y: 1 };
            friend = { x: 18, y: 18 };
            
            // é›£æ˜“åº¦ã«ã‚ˆã‚‹æ•µã®æ•°
            let enemyCount;
            switch(gameState.selectedDifficulty) {
                case 'easy': enemyCount = 3; break;
                case 'normal': enemyCount = 4; break;
                case 'hard': enemyCount = 5; break;
                case 'extreme': enemyCount = 6; break;
                default: enemyCount = 3;
            }
            
            // æ•µã®é…ç½®
            movingEnemies = [];
            const enemyPositions = [
                { x: 7, y: 7, dx: 1, dy: 0 },
                { x: 15, y: 10, dx: 0, dy: 1 },
                { x: 5, y: 15, dx: -1, dy: 0 },
                { x: 12, y: 3, dx: 1, dy: 0 },
                { x: 3, y: 12, dx: 0, dy: -1 },
                { x: 17, y: 6, dx: -1, dy: 0 },
                { x: 8, y: 16, dx: 0, dy: 1 },
                { x: 14, y: 14, dx: 1, dy: 0 }
            ];
            
            for (let i = 0; i < Math.min(enemyCount, enemyPositions.length); i++) {
                movingEnemies.push({ ...enemyPositions[i] });
            }
            
            // å®ç®±ã®é…ç½®
            treasures = [];
            const treasurePositions = [
                { x: 10, y: 5, collected: false },
                { x: 3, y: 8, collected: false },
                { x: 16, y: 3, collected: false },
                { x: 6, y: 12, collected: false },
                { x: 13, y: 7, collected: false },
                { x: 2, y: 16, collected: false },
                { x: 17, y: 12, collected: false },
                { x: 9, y: 14, collected: false }
            ];
            
            for (let i = 0; i < enemyCount; i++) {
                if (treasurePositions[i]) {
                    treasures.push({ ...treasurePositions[i] });
                }
            }
            
            gameState.weaponCount = 0;
            gameState.treasureCount = 0;
            gameRunning = true;
            lastEnemyMove = Date.now();
            updateInventory();
            drawGame();
            
            moveEnemies();
        }

        function drawGame() {
            ctx.fillStyle = '#0f0f23';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const cellSize = Math.min(canvas.width / 20, canvas.height / 20);

            // è¿·è·¯ã‚’æç”»
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    if (maze[y][x] === 1) {
                        ctx.fillStyle = '#2d3436';
                        ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                        ctx.fillStyle = '#636e72';
                        ctx.fillRect(x * cellSize + 2, y * cellSize + 2, cellSize - 4, cellSize - 4);
                    }
                }
            }

            // å®ç®±ã‚’æç”»
            treasures.forEach(treasure => {
                if (!treasure.collected) {
                    const treasureImagePath = gameImages.items.treasure;
                    if (treasureImagePath && loadedImages[treasureImagePath]) {
                        ctx.drawImage(loadedImages[treasureImagePath], treasure.x * cellSize, treasure.y * cellSize, cellSize, cellSize);
                    } else {
                        drawDefaultTreasure(treasure.x, treasure.y, cellSize);
                    }
                }
            });

            // å‹•ãæ•µã‚’æç”»
            movingEnemies.forEach((enemy, index) => {
                const enemyImagePath = gameImages.enemies.zombie;
                if (enemyImagePath && loadedImages[enemyImagePath]) {
                    ctx.drawImage(loadedImages[enemyImagePath], enemy.x * cellSize, enemy.y * cellSize, cellSize, cellSize);
                } else {
                    ctx.fillStyle = '#e84118';
                    ctx.fillRect(enemy.x * cellSize + 2, enemy.y * cellSize + 2, cellSize - 4, cellSize - 4);
                    
                    ctx.fillStyle = '#ffffff';
                    ctx.font = `${cellSize * 0.6}px monospace`;
                    ctx.textAlign = 'center';
                    ctx.fillText('ğŸ‘»', enemy.x * cellSize + cellSize/2, enemy.y * cellSize + cellSize/2 + 4);
                }
            });

            // å‹é”ã‚’æç”»ï¼ˆã‚´ãƒ¼ãƒ«åœ°ç‚¹ï¼‰
            if (gameImages.items.friend && loadedImages[gameImages.items.friend]) {
                ctx.drawImage(loadedImages[gameImages.items.friend], friend.x * cellSize, friend.y * cellSize, cellSize, cellSize);
            } else {
                ctx.fillStyle = '#00b894';
                ctx.fillRect(friend.x * cellSize + 2, friend.y * cellSize + 2, cellSize - 4, cellSize - 4);
                
                ctx.fillStyle = '#ffffff';
                ctx.font = `${cellSize * 0.6}px monospace`;
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ‘¥', friend.x * cellSize + cellSize/2, friend.y * cellSize + cellSize/2 + 4);
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æç”»
            const playerImagePath = gameImages.characters[gameState.selectedCharacter];
            if (playerImagePath && loadedImages[playerImagePath]) {
                ctx.drawImage(loadedImages[playerImagePath], player.x * cellSize, player.y * cellSize, cellSize, cellSize);
            } else {
                drawDefaultPlayer(cellSize);
            }
        }
        
        function drawDefaultTreasure(x, y, cellSize) {
            ctx.fillStyle = '#fdcb6e';
            ctx.fillRect(x * cellSize + 2, y * cellSize + 2, cellSize - 4, cellSize - 4);
            ctx.fillStyle = '#e17055';
            ctx.fillRect(x * cellSize + 4, y * cellSize + 4, cellSize - 8, cellSize - 8);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = `${cellSize * 0.6}px monospace`;
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ’°', x * cellSize + cellSize/2, y * cellSize + cellSize/2 + 4);
        }
        
        function drawDefaultPlayer(cellSize) {
            ctx.fillStyle = '#74b9ff';
            ctx.fillRect(player.x * cellSize + 3, player.y * cellSize + 3, cellSize - 6, cellSize - 6);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = `${cellSize * 0.6}px monospace`;
            ctx.textAlign = 'center';
            ctx.fillText('ğŸ˜Š', player.x * cellSize + cellSize/2, player.y * cellSize + cellSize/2 + 4);
        }

        function movePlayer(dx, dy) {
            if (!gameRunning) return;

            const newX = player.x + dx;
            const newY = player.y + dy;

            if (maze[newY] && maze[newY][newX] !== 1) {
                player.x = newX;
                player.y = newY;

                // å®ç®±ã¨ã®è¡çªåˆ¤å®š
                treasures.forEach((treasure, index) => {
                    if (!treasure.collected && player.x === treasure.x && player.y === treasure.y) {
                        treasure.collected = true;
                        gameState.weaponCount++;
                        gameState.treasureCount++;
                        updateInventory();
                        
                        const weapons = ['ğŸ—¡ï¸ å‰£', 'ğŸ¹ å¼“', 'ğŸ”¥ ãƒ•ã‚¡ã‚¤ã‚¢ãƒœãƒ¼ãƒ«'];
                        const randomWeapon = weapons[Math.floor(Math.random() * weapons.length)];
                        
                        showPopup(`${randomWeapon}ã‚’ã‚²ãƒƒãƒˆï¼`, `${randomWeapon}ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼<br>ã“ã‚Œã§æ•µã‚’å€’ã›ã‚‹ã‚ˆï¼`);
                    }
                });

                // å‹•ãæ•µã¨ã®è¡çªåˆ¤å®š
                for (let i = movingEnemies.length - 1; i >= 0; i--) {
                    const enemy = movingEnemies[i];
                    if (player.x === enemy.x && player.y === enemy.y) {
                        if (gameState.weaponCount > 0) {
                            movingEnemies.splice(i, 1);
                            gameState.weaponCount--;
                            updateInventory();
                            showPopup('âš”ï¸ æ•µã‚’å€’ã—ãŸï¼', `æ•µã‚’ã‚„ã£ã¤ã‘ãŸï¼<br>æ­¦å™¨ãŒ1ã¤æ¸›ã£ãŸã‚ˆ<br>æ®‹ã‚Šæ­¦å™¨ï¼š${gameState.weaponCount}å€‹`);
                        } else {
                            gameRunning = false;
                            showPopup('ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼', 'æ­¦å™¨ãŒãªã„ã¨æ•µã«ã‚„ã‚‰ã‚Œã¡ã‚ƒã£ãŸï¼<br>æ¬¡ã¯ã‚‚ã£ã¨æ°—ã‚’ã¤ã‘ã‚ˆã†ï¼', () => {
                                showGameOver();
                            });
                            return;
                        }
                        break;
                    }
                }

                // å‹é”ï¼ˆã‚´ãƒ¼ãƒ«ï¼‰ã¨ã®è¡çªåˆ¤å®š
                if (player.x === friend.x && player.y === friend.y) {
                    gameRunning = false;
                    
                    const newFriend = getRandomCharacter();
                    if (newFriend && !gameState.unlockedCharacters.includes(newFriend)) {
                        gameState.unlockedCharacters.push(newFriend);
                        showPopup('ğŸ‰ å‹é”ã«ä¼šãˆãŸï¼', `${newFriend}ã«ä¼šãˆãŸï¼ã‚„ã£ãŸãƒ¼ï¼<br>æ–°ã—ã„å‹é”ã‚’ã‚²ãƒƒãƒˆã—ãŸã‚ˆï¼`, () => {
                            showClearScreen(newFriend);
                        });
                    } else {
                        showPopup('ğŸ‰ å‹é”ã«ä¼šãˆãŸï¼', 'å‹é”ã«ä¼šãˆãŸï¼ã‚„ã£ãŸãƒ¼ï¼', () => {
                            showClearScreen();
                        });
                    }
                    
                    gameState.clearedStages.push(gameState.currentStage);
                    saveGameData();
                }

                drawGame();
            }
        }

        function getRandomCharacter() {
            const allCharacters = ['ãŸã„ã‚ˆã†', 'ã‚ãã‚‰', 'ã‚ã‚‹ã¾', 'ã„ãŠã‚Š', 'ã—ã‚…ã†ã”', 
                                   'ã¾ã»', 'ã—ã¥ã', 'ã‚ã•ã²', 'ã—ã‚…ã‚“', 'ã‚ã¤ã“'];
            const locked = allCharacters.filter(char => !gameState.unlockedCharacters.includes(char));
            return locked.length > 0 ? locked[Math.floor(Math.random() * locked.length)] : null;
        }

        // æ•µã®ç§»å‹•å‡¦ç†
        function moveEnemies() {
            if (!gameRunning) return;
            
            let enemySpeed;
            switch(gameState.selectedDifficulty) {
                case 'easy': enemySpeed = 800; break;
                case 'normal': enemySpeed = 500; break;
                case 'hard': enemySpeed = 300; break;
                case 'extreme': enemySpeed = 150; break;
                default: enemySpeed = 500;
            }
            
            const now = Date.now();
            if (now - lastEnemyMove > enemySpeed) {
                movingEnemies.forEach(enemy => {
                    const newX = enemy.x + enemy.dx;
                    const newY = enemy.y + enemy.dy;
                    
                    if (!maze[newY] || maze[newY][newX] === 1 || newX < 0 || newX >= 20 || newY < 0 || newY >= 20) {
                        const directions = [
                            { dx: 1, dy: 0 },
                            { dx: -1, dy: 0 },
                            { dx: 0, dy: 1 },
                            { dx: 0, dy: -1 }
                        ];
                        const randomDirection = directions[Math.floor(Math.random() * directions.length)];
                        enemy.dx = randomDirection.dx;
                        enemy.dy = randomDirection.dy;
                    } else {
                        enemy.x = newX;
                        enemy.y = newY;
                    }
                });
                
                lastEnemyMove = now;
                drawGame();
            }
            
            if (gameRunning) {
                requestAnimationFrame(moveEnemies);
            }
        }

        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
        function showPopup(title, message, callback = null) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').innerHTML = message;
            document.getElementById('popup').classList.add('show');
            
            window.popupCallback = callback;
        }

        function closePopup() {
            document.getElementById('popup').classList.remove('show');
            
            if (window.popupCallback) {
                setTimeout(window.popupCallback, 100);
                window.popupCallback = null;
            }
        }

        function updateInventory() {
            const weaponSlot = document.getElementById('weapon-slot');
            
            if (gameState.weaponCount > 0) {
                weaponSlot.classList.add('has-item');
                weaponSlot.textContent = `ğŸ—¡ï¸${gameState.weaponCount}`;
            } else {
                weaponSlot.classList.remove('has-item');
                weaponSlot.textContent = 'ğŸ”’';
            }
        }

        function showClearScreen(newCharacter = null) {
            const message = document.getElementById('clear-message');
            const newCharEl = document.getElementById('new-character');
            
            message.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¸ ${gameState.currentStage} ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼`;
            
            if (newCharacter) {
                newCharEl.textContent = `ğŸ‰ ã‚ãŸã‚‰ã—ã„å‹é”ã€Œ${newCharacter}ã€ã‚’ã‚²ãƒƒãƒˆã—ãŸï¼`;
                newCharEl.style.display = 'block';
            } else {
                newCharEl.style.display = 'none';
            }
            
            showScreen('clear-screen');
        }

        function showGameOver() {
            showScreen('gameover-screen');
        }

        function restartGame() {
            showScreen('game-screen');
            initializeGame();
        }

        // ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        function updateCharacterButtons() {
            document.querySelectorAll('.character-button').forEach(button => {
                const character = button.dataset.character;
                if (gameState.unlockedCharacters.includes(character)) {
                    button.disabled = false;
                    button.style.opacity = '1';
                } else {
                    button.disabled = true;
                    button.style.opacity = '0.5';
                }
            });
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', function(e) {
            switch(e.key) {
                case 'ArrowUp': movePlayer(0, -1); break;
                case 'ArrowDown': movePlayer(0, 1); break;
                case 'ArrowLeft': movePlayer(-1, 0); break;
                case 'ArrowRight': movePlayer(1, 0); break;
            }
        });

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ç”¨ï¼‰- ç”»é¢ã®æºã‚Œã‚’é˜²æ­¢
        let touchStartX, touchStartY;

        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            touchStartX = touch.clientX - rect.left;
            touchStartY = touch.clientY - rect.top;
        }, { passive: false });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            e.stopPropagation();
        }, { passive: false });

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (!touchStartX || !touchStartY) return;

            const touch = e.changedTouches[0];
            const rect = canvas.getBoundingClientRect();
            const touchEndX = touch.clientX - rect.left;
            const touchEndY = touch.clientY - rect.top;

            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;

            // æœ€å°ç§»å‹•è·é›¢ã‚’è¨­å®š
            const minDistance = 20;
            if (Math.abs(dx) > minDistance || Math.abs(dy) > minDistance) {
                if (Math.abs(dx) > Math.abs(dy)) {
                    movePlayer(dx > 0 ? 1 : -1, 0);
                } else {
                    movePlayer(0, dy > 0 ? 1 : -1);
                }
            }
        }, { passive: false });

        // å…¨ä½“ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚’åˆ¶å¾¡
        document.addEventListener('touchmove', function(e) {
            if (e.target === canvas || e.target.closest('.character-select')) {
                return; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯è¨±å¯
            }
            e.preventDefault();
        }, { passive: false });

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        loadGameData();

        // åˆæœŸåŒ–
        updateCharacterButtons();
        updateStageButtons();

        // ç”»åƒã‚’è¨­å®š
        setItemImage('treasure', 'images/items/treasure_red_gold.png');
        setCharacterImage('ãŸã„ã‚ˆã†', 'images/characters/taiyou_small.png', 'images/characters/taiyou_large.png');
        setEnemyImage('zombie', 'images/enemies/character_monster_zombie_02_green.png');
    </script>
</body>
</html>